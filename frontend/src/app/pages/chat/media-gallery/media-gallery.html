<!-- Grid View -->
@if (_processedAttachments.length > 0) {
  <div class="media-grid" [ngClass]="gridClass">
    @for (attachment of displayAttachments; track attachment.url; let i = $index) {
      <div class="grid-item" (click)="openViewer(i)">
        <!-- Display Image with Lazy Loading -->
        @if (attachment.type === 'image') {
          <img [src]="attachment.url" alt="Chat Attachment" loading="lazy">
        }
        <!-- Display Video Thumbnail with Metadata Preloading -->
        @if (attachment.type === 'video') {
          <div class="video-container">
            <video [src]="attachment.url" preload="metadata"></video>
            <div class="play-icon"></div>
          </div>
        }
        <!-- Overlay for more than 4 items -->
        @if (i === 3 && moreCount > 0) {
          <div class="more-overlay">
            +{{ moreCount }}
          </div>
        }
      </div>
    }
  </div>
}

<!-- Lightbox/Viewer View -->
@if (isViewerOpen) {
  <div class="viewer-overlay" (click)="closeViewer()">
    <div class="viewer-header" (click)="handleContentClick($event)">
      <!-- Empty div for spacing on the left -->
      <div class="header-left-spacer"></div>
      <!-- Title is now in the center -->
      <span class="viewer-title">{{ _processedAttachments[selectedAttachmentIndex].originalName }}</span>
      <!-- Container for all right-side controls -->
      <div class="header-controls-right">
        <!-- Action Buttons -->
        <div class="viewer-actions">
          @if (_processedAttachments[selectedAttachmentIndex].type === 'image') {
            <button class="icon-btn" (click)="zoomIn()" title="Zoom In">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
            </button>
            <button class="icon-btn" (click)="zoomOut()" title="Zoom Out">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
            </button>
            <button class="icon-btn" (click)="rotateRight()" title="Rotate Right">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
            </button>
          }
          <!-- Download Button -->
          <button class="icon-btn" (click)="downloadAttachment()" title="Download">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          </button>
        </div>
        <!-- Close button -->
        <button class="icon-btn close-btn" (click)="closeViewer()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
    </div>
    <!-- Main content area -->
    <div class="viewer-content" (click)="handleContentClick($event)">
      <!-- Previous Button -->
      @if (_processedAttachments.length > 1) {
        <button class="icon-btn nav-btn prev-btn" (click)="previousAttachment()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
      }
      <!-- Media Display -->
      <div 
        class="media-wrapper" 
        [class.is-pannable]="currentScale > 1"
        (mousedown)="onMouseDown($event)">
        @if (_processedAttachments[selectedAttachmentIndex].type === 'image') {
          <img 
            [src]="_processedAttachments[selectedAttachmentIndex].url" 
            [style.transform]="transformStyle" 
            alt="Viewer Attachment">
        } @else {
          <video [src]="_processedAttachments[selectedAttachmentIndex].url" controls autoplay></video>
        }
      </div>
      <!-- Next Button -->
      @if (_processedAttachments.length > 1) {
        <button class="icon-btn nav-btn next-btn" (click)="nextAttachment()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>
      }
    </div>
    <!-- Footer with thumbnails -->
    @if (_processedAttachments.length > 1) {
      <div class="viewer-footer" (click)="handleContentClick($event)">
        <!-- Thumbnail Strip -->
        <div class="thumbnail-strip">
          @for (attachment of _processedAttachments; track attachment.url; let i = $index) {
            <div class="thumbnail-item" [class.active]="i === selectedAttachmentIndex" (click)="selectFromThumbnail(i)">
              @if (attachment.type === 'image') {
                <img [src]="attachment.url" alt="Thumbnail">
              } @else {
                <div class="video-thumb">
                  <video [src]="attachment.url" preload="metadata"></video>
                  <div class="play-icon-small"></div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>
}
