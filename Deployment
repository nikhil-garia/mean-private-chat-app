pipeline {
    agent any

    tools {
        jdk 'jdk17'
        nodejs 'node16'
    }

    environment {
        STADIA_API_KEY = credentials('STADIA_API_KEY')
        OPENAI_API_KEY = credentials('OPENAI_API_KEY')
        GEMINI_API_KEY = credentials('GEMINI_API_KEY')
        MONGO_URL      = credentials('MONGO_URL')
        FCM_PROJECT_ID = credentials('FCM_PROJECT_ID')
        SESSION_SECRET = credentials('SESSION_SECRET')   // âœ… ADDED
    }

    stages {

        stage("Deploy to Container") {
            steps {
                script {

                    echo "ðŸ›‘ Removing old container..."
                    sh """
                        if [ \$(docker ps -aq -f name=nextalk) ]; then
                            docker rm -f nextalk
                        fi
                    """

                    echo "ðŸš€ Starting new container with environment variables..."

                    sh """
                        docker run -d --name nextalk \
                            -p 3000:8080 \
                            -e STADIA_API_KEY='${STADIA_API_KEY}' \
                            -e OPENAI_API_KEY='${OPENAI_API_KEY}' \
                            -e GEMINI_API_KEY='${GEMINI_API_KEY}' \
                            -e MONGO_URL='${MONGO_URL}' \
                            -e FCM_PROJECT_ID='${FCM_PROJECT_ID}' \
                            -e SESSION_SECRET='${SESSION_SECRET}' \
                            -e NODE_ENV='production' \
                            -e PORT='8080' \
                            9808nikhil/nextalk:latest
                    """
                }
            }
        }

    }
}
